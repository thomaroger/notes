{# templates/front/child/notes.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Notes -
	{{ child.firstName }}
	{{ child.lastName }}
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1 class="h3">
				<i class="fas fa-user"></i>
				Notes de
				{{ child.firstName }}
				{{ child.lastName }}
			</h1>
			<div>
				<form method="get" class="d-flex align-items-center">
					<label class="me-2" for="childSelect">Sélectionner un enfant :</label>
					<select name="child" id="childSelect" class="form-select" onchange="this.form.submit()">
						{% for c in children %}
							<option value="{{ c.id }}" {% if c.id == child.id %} selected {% endif %}>
								{{ c.firstName }}
								{{ c.lastName }}
							</option>
						{% endfor %}
					</select>
				</form>
			</div>
		</div>

		{% for theme, assessments in groupedByTheme %}
			<div class="card shadow-sm mb-4">
				<div class="card-header bg-secondary text-white">
					<h3 class="mb-0">{{ theme }}</h3>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-striped table-hover text-center mb-0">
							<thead class="table-dark">
								<tr>
									<th>Titre</th>
									<th>Note</th>
									<th>% Réussite</th>
								</tr>
							</thead>
							<tbody>
								{% set totalScore = 0 %}
								{% set totalMax = 0 %}
								{% for assessment in assessments|sort((a, b) => a.date <=> b.date) %}
									{% set scoreObj = child.scores|filter(s => s.assessment.id == assessment.id)|first %}
									{% set scoreValue = scoreObj ? scoreObj.score : null %}
									{% set absent = scoreObj and scoreObj.absent ?? false %}
									{% set percentage = scoreValue is not null ? (scoreValue / assessment.maxScore) * 100 : 0 %}

									{% set rowClass = '' %}
									{% if absent %}
										{% set rowClass = 'table-warning' %}
									{% elseif percentage < 40 %}
										{% set rowClass = 'table-danger' %}
									{% elseif percentage <= 75 %}
										{% set rowClass = 'table-warning' %}
									{% else %}
										{% set rowClass = 'table-success' %}
									{% endif %}

									<tr class="{{ rowClass }}">
                                        <td>
                                        <a href="{{ path('score_edit', {'assessment': assessment.id}) }}">{{ assessment.title }} - {{ assessment.date|date('d/m/Y') }}</a>
                                        </td>
										<td>
											{% if absent %} Absent
											{% else %}
												{{ scoreValue }} / {{ assessment.maxScore }}
											{% endif %}
										</td>
										<td>
											{% if not absent %}
												{{ percentage|number_format(0) }}%{% else %}-
											{% endif %}
										</td>
									</tr>

									{% if not absent %}
										{% set totalScore = totalScore + scoreValue %}
										{% set totalMax = totalMax + assessment.maxScore %}
									{% endif %}
								{% endfor %}
								{# Ligne pour le pourcentage global du thème #}
								<tr class="fw-bold">
									<td colspan="2">Pourcentage global
										{{ theme }}</td>
									<td>
										{% if totalMax > 0 %}
											{{ ((totalScore / totalMax) * 100)|number_format(0) }}%
										{% else %}
											-
										{% endif %}
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		{% endfor %}
	</div>
{% endblock %}

