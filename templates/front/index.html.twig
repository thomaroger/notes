{% extends 'base.html.twig' %}
{% block title %}Notes - Liste des évaluations
{% endblock %}
{% block stylesheets %}
	{{ parent() }}
	<style>
		.progress {
			height: 20px;
		}
		.progress-bar {
			line-height: 20px;
			font-size: 0.85rem;
		}
		.table thead th {
			vertical-align: middle;
		}
		.accordion-button::after {
			flex-shrink: 0;
		}
	</style>
{% endblock %}
{% block body %}
	<div class="container mt-4">
		<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
			<div class="mb-3 mb-md-0">
				<h1 class="h3 mb-0">
					<i class="fas fa-clipboard-list me-2"></i>
					Évaluations
				</h1>
			</div>
			<a href="{{ path('assessment_new') }}" class="btn btn-primary btn-lg">
				<i class="fas fa-plus-circle me-2"></i>
				Créer une évaluation
			</a>
		</div>
		{% for theme, assessments in groupedByTheme %}
			<div class="card shadow-sm mb-4">
				<div class="card-header bg-secondary text-white">
					<h4 class="mb-0">{{ theme }}</h4>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-striped table-hover text-center mb-0">
							<thead class="table-dark">
								<tr>
									<th>Titre</th>
									<th>Classe</th>
									<th>Note max</th>
									<th>Date</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								{% for assessment in assessments %}
									{% set classStyle = 'danger' %}
									{% set totalEffective = assessment.stats.present + assessment.stats.absent %}
									{% if totalEffective == 0 %}
										{% set classStyle = 'danger' %}
									{% elseif totalEffective == assessment.stats.total %}
										{% set classStyle = 'success' %}
									{% else %}
										{% set classStyle = 'warning' %}
									{% endif %}
									<tr class="table-{{classStyle}}"> 
									<td class="fw-bold">{{ assessment.title }} </td> 
									<td> {{ assessment.schoolClass.level }} </td>
									<td>{{ assessment.maxScore }}</td>
									<td>{{ assessment.date|date('d/m/Y') }}</td>
										<td class="text-end">
											<button class="btn btn-info btn-sm accordion-trigger" type="button" data-bs-toggle="collapse" data-bs-target="#stats-{{ assessment.id }}" aria-expanded="false" aria-controls="stats-{{ assessment.id }}">
												<i class="fas fa-chart-bar me-1"></i>
												Stats
											</button>
											<a href="{{ path('score_edit', {'assessment': assessment.id}) }}" class="btn btn-success btn-sm">
												<i class="fas fa-pen me-1"></i>
												Saisir notes
											</a>
										</td>
									</tr>
									<tr class="collapse bg-light" id="stats-{{ assessment.id }}">
										<td colspan="5">
											<div
												class="container py-2">
												{# 1ère ligne : Élèves notés / Élèves absents #}
												<div class="row g-3 mb-3">
													<div class="col-md-6 text-start">
														<label>Élèves notés :
															{{ assessment.stats.present }}/{{ assessment.stats.total }}</label>
														<div class="progress">
															<div class="progress-bar bg-success" style="width: {{ (assessment.stats.present/assessment.stats.total)*100 }}%"></div>
														</div>
													</div>
													<div class="col-md-6 text-start">
														<label>Élèves absents :
															{{ assessment.stats.absent }}/{{ assessment.stats.total }}</label>
														<div class="progress">
															<div class="progress-bar bg-warning" style="width: {{ (assessment.stats.absent/assessment.stats.total)*100 }}%"></div>
														</div>
													</div>
												</div>
												<hr/>
												{# 2ème ligne : Min / Max / Moyenne #}
												<div class="row g-3 mb-3">
													<div class="col-md-4 text-start">
														<label>Note min :
															{{ assessment.stats.min }}/{{ assessment.maxScore }}</label>
														<div class="progress">
															<div class="progress-bar bg-danger" style="width: {{ (assessment.stats.min/assessment.maxScore)*100 }}%"></div>
														</div>
													</div>
													<div class="col-md-4 text-start">
														<label>Note max :
															{{ assessment.stats.max }}/{{ assessment.maxScore }}</label>
														<div class="progress">
															<div class="progress-bar bg-success" style="width: {{ (assessment.stats.max/assessment.maxScore)*100 }}%"></div>
														</div>
													</div>
													<div class="col-md-4 text-start">
														<label>Moyenne :
															{{ assessment.stats.avg|number_format(2) }}/{{ assessment.maxScore }}</label>
														<div class="progress">
															<div class="progress-bar bg-info" style="width: {{ (assessment.stats.avg/assessment.maxScore)*100 }}%"></div>
														</div>
													</div>
												</div>
												<hr/>
												{# 3ème ligne : Taux de réussite #}
												<div class="row g-3">
													<div class="col-md-4 text-start">
														<label>Moins de 40% de réussite :
															{{ assessment.stats.less40 }}
															élèves</label>
														<div class="progress">
															<div class="progress-bar bg-danger" style="width: {{ (assessment.stats.less40/assessment.stats.total)*100 }}%"></div>
														</div>
													</div>
													<div class="col-md-4 text-start">
														<label>41%-75% de réussite :
															{{ assessment.stats.between41_75 }}
															élèves</label>
														<div class="progress">
															<div class="progress-bar bg-warning" style="width: {{ (assessment.stats.between41_75/assessment.stats.total)*100 }}%"></div>
														</div>
													</div>
													<div class="col-md-4 text-start">
														<label>Plus de 75% de réussite :
															{{ assessment.stats.more75 }}
															élèves</label>
														<div class="progress">
															<div class="progress-bar bg-success" style="width: {{ (assessment.stats.more75/assessment.stats.total)*100 }}%"></div>
														</div>
													</div>
												</div>
												<hr/>
												<table class="table table-striped">
													<thead>
														<tr>
															<th>Élève</th>
															<th>Note</th>
														</tr>
													</thead>
													<tbody>
														{% for score in assessment.scores %}
															{% if score.absent %}
																{% set rowClass = 'table-warning' %}
															{% elseif score.score is null %}
																{% set rowClass = 'table-danger' %}
															{% else %}
																{% set percentage = (score.score / assessment.maxScore) * 100 %}
																{% if percentage < 40 %}
																	{% set rowClass = 'table-danger' %}
																{% elseif percentage <= 75 %}
																	{% set rowClass = 'table-warning' %}
																{% else %}
																	{% set rowClass = 'table-success' %}
																{% endif %}
															{% endif %}
															<tr class="{{ rowClass }}">
																<td>{{ score.child.firstName }}
																	{{ score.child.lastName }}</td>
																<td>
																	{% if score.absent %}
																		Absent
																	{% elseif score.score is null %}
																		—
																	{% else %}
																		{{ score.score }}
																		/
																		{{ assessment.maxScore }}
																	{% endif %}
																</td>
															{% endfor %}
														</tbody>
													</tbody>
												</table>
											</div>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		{% endfor %}
	</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
	<script>
		document.querySelectorAll('button[data-bs-toggle="collapse"]').forEach(button => {
const targetId = button.getAttribute('data-bs-target');
const targetRow = document.querySelector(targetId);
const tableRow = button.closest('tr');

targetRow.addEventListener('show.bs.collapse', () => {
tableRow.classList.add('table-active'); // surbrillance ligne
});
targetRow.addEventListener('hide.bs.collapse', () => {
tableRow.classList.remove('table-active');
});
});

document.querySelectorAll('.accordion-trigger').forEach(btn => {
btn.addEventListener('click', () => {
console.log('toto');
document.querySelectorAll('.collapse.show').forEach(el => {
new bootstrap.Collapse(el, {toggle: false}).hide();
});
});
});
	</script>
{% endblock %}
